<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Space Day Quiz 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0a0f1f;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            overflow-x: hidden;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass-card {
            background: rgba(16, 24, 45, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
        }
        .isro-orange { color: #f37021; }
        .isro-blue { color: #0054a6; }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #f37021;
            color: #ffffff;
            border: 1px solid #f37021;
            box-shadow: 0 0 15px rgba(243, 112, 33, 0.4);
        }
        .btn-primary:hover {
            background-color: #ffffff;
            color: #f37021;
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(243, 112, 33, 0.7);
        }
        .btn-primary:disabled {
            background-color: #f37021;
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        .btn-secondary {
            background-color: transparent;
            border: 2px solid #0054a6;
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #0054a6;
            color: #ffffff;
        }
        .dark-input {
            background-color: rgba(10, 15, 31, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            border-radius: 0.375rem;
        }
        .dark-input::placeholder {
            color: #888;
        }
        .dark-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #f37021;
            border-color: #f37021;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #f37021;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    
    <!-- Big Corner countdown timer display -->
    <div id="corner-countdown" class="hidden absolute top-5 right-5 glass-card text-isro-orange p-4 rounded-full shadow-2xl text-4xl font-bold font-orbitron w-24 h-24 flex items-center justify-center"></div>

    <div id="app" class="glass-card w-full max-w-lg mx-auto">
        <div class="p-8 space-y-6">
            <!-- Initial View: Role Selection -->
            <div id="role-selection-view" class="text-center">
                <h1 class="text-3xl font-bold mb-4 font-orbitron isro-orange">Space Day Quiz 2025</h1>
                <p class="text-gray-300 mb-8">Please select your role to continue.</p>
                <div class="space-y-4">
                    <button onclick="showLogin('admin')" class="w-full btn btn-primary">I am an Admin</button>
                    <button onclick="showLogin('participant')" class="w-full btn btn-primary">I am a Participant</button>
                </div>
            </div>

            <!-- Login View -->
            <div id="login-view" class="hidden text-center">
                <h2 id="login-title" class="text-2xl font-bold mb-6 font-orbitron"></h2>
                <input type="password" id="password-input" class="w-full p-2 mb-4 dark-input" placeholder="Enter Password">
                <input type="text" id="name-input" class="w-full p-2 mb-4 hidden dark-input" placeholder="Enter Team Code">
                <button onclick="handleLogin()" class="w-full btn btn-primary">Continue</button>
                <button onclick="showRoleSelection()" class="mt-4 text-blue-400 hover:underline">Go Back</button>
                <p id="login-error" class="text-red-400 mt-4"></p>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-2 font-orbitron isro-orange">Admin Dashboard</h2>
                <p class="text-gray-300 mb-6">Control the quiz from here.</p>
                <div id="admin-status" class="mb-6 p-4 bg-gray-900/50 rounded-md border border-gray-700"></div>
                <div id="admin-timer" class="hidden text-3xl font-bold text-isro-orange font-orbitron bg-gray-900/50 p-2 rounded-md border border-gray-700 my-4 mx-auto w-fit"></div>
                <div class="space-y-4">
                    <button id="start-quiz-btn" onclick="startQuiz()" class="w-full btn btn-primary">Start Quiz</button>
                    <button id="show-results-btn" onclick="showAdminResults()" class="hidden w-full btn btn-primary bg-green-600 border-green-600 hover:text-green-600">Show Results</button>
                    <button onclick="resetQuiz()" class="w-full btn btn-primary bg-red-600 border-red-600 hover:text-red-600">Reset Quiz</button>
                </div>
                
                <div id="admin-ranking-view" class="hidden mt-6 text-left bg-gray-900/50 p-4 border border-gray-700 rounded-md">
                    <h3 class="text-lg font-bold mb-4 text-center font-orbitron">Final Results</h3>
                    <div id="admin-ranking-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Participant View -->
            <div id="participant-view" class="hidden">
                <!-- Waiting Screen -->
                <div id="waiting-screen" class="text-center">
                    <h2 class="text-2xl font-bold mb-4">Welcome, <span id="participant-name" class="isro-orange font-orbitron"></span>!</h2>
                    <p class="text-gray-300 mb-6">The quiz will begin shortly. Please wait for the admin to start.</p>
                    <div class="loader mx-auto"></div>
                </div>

                <!-- Quiz Screen -->
                <div id="quiz-screen" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold font-orbitron">Quiz in Progress</h2>
                        <div id="timer" class="text-xl font-bold text-isro-orange font-orbitron bg-gray-900/50 p-2 rounded-md border border-gray-700">01:00</div>
                    </div>
                    <div id="question-container" class="bg-gray-900/50 p-4 border border-gray-700 rounded-md">
                        <p class="text-lg font-bold mb-4" id="question-text"></p>
                        <div id="options-container" class="space-y-2"></div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="prev-btn" onclick="navigateQuestion(-1)" class="btn btn-secondary">Previous</button>
                        <button id="next-btn" onclick="navigateQuestion(1)" class="btn btn-primary">Next</button>
                        <button id="submit-btn" onclick="submitQuiz()" class="hidden btn btn-primary bg-green-600 border-green-600 hover:text-green-600">Submit</button>
                    </div>
                </div>

                <!-- Ranking Screen (Now only used as a container for messages) -->
                <div id="ranking-screen" class="hidden text-center">
                     <div class="bg-gray-900/50 p-6 border border-gray-700 rounded-md">
                         <h2 class="text-2xl font-bold mb-6 font-orbitron isro-orange">Quiz Over!</h2>
                         <p class="text-gray-300 mb-6">Here are the final rankings:</p>
                         <div id="ranking-list" class="space-y-2 text-left"></div>
                     </div>
                     <button onclick="showRoleSelection()" class="mt-8 btn btn-primary">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRyBGcSgLaH6jbqgDY9Yn8t1Rw9o-jWJw",
            authDomain: "nspd25-996bf.firebaseapp.com",
            databaseURL: "https://nspd25-996bf-default-rtdb.firebaseio.com",
            projectId: "nspd25-996bf",
            storageBucket: "nspd25-996bf.appspot.com",
            messagingSenderId: "678844470957",
            appId: "1:678844470957:web:04a29772c95ebf67c21824",
            measurementId: "G-GRCBT2KMKH"
        };

        // --- App Initialization ---
        let app, db, auth, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.body.innerHTML = `<div class="text-red-500 p-4">Error: Firebase configuration is missing or invalid.</div>`;
        }

        // --- Global State ---
        let currentRole = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizTimerInterval;
        let cornerTimerInterval;
        let adminTimerInterval;
        let audioCtx; // For generating sound
        let quizStartTime;
        let participantDocId = null;
        let isSubmitted = false;
        let participantQuiz = []; // Holds the shuffled quiz for the current participant
        const quizDuration = 600;
        const questions = [
            {
    text: "Active Galactic Nuclei (AGNs) can appear as quasars, Seyfert galaxies, or radio galaxies, yet these are understood within a unified model framework. Which explanation best accounts for this apparent diversity of AGN types?",
    options: [
        "Different AGN classes are powered by entirely different mechanisms, with quasars fueled by nuclear fusion, Seyferts by stellar collisions, and radio galaxies by black hole accretion",
        "The diversity arises from evolutionary stages: quasars evolve into Seyfert galaxies and finally fade into radio galaxies as their central black hole exhausts available fuel",
        "All AGNs are fundamentally powered by accretion onto supermassive black holes, but orientation relative to the observer, the structure of the obscuring torus, and the presence or absence of strong radio jets determine the observed classification",
        "The classification depends primarily on the host galaxy morphology: elliptical galaxies always host quasars, while spiral galaxies host Seyferts and irregular galaxies produce radio galaxies"
    ],
    correctAnswer: 2
}
,
            {
                text: "Why is iron the end point of stellar nucleosynthesis in massive stars?",
                options: [
                    "Iron nuclei collect in the stellar core where their nuclear binding resists fusion, altering energy transport and halting reactions",
                    "Fusion beyond iron consumes energy; binding energy per nucleon peaks, so further fusion is endothermic",
                    "Neutrino-driven processes fragment heavier nuclei more easily than iron, making iron the most stable core product",
                    "Radiation pressure inside advanced stellar cores disrupts iron-group nuclei, preventing stable production of heavier species"
                ],
                correctAnswer: 1
            },
            {
        text: "Astronomers detect a star orbiting an invisible object with very short orbital period. What indicates the object is a black hole?",
        options: [
            "The orbit is nearly circular",
            "The star’s orbit implies an extremely massive but compact object",
            "No visible light is seen from the object",
            "The star is very luminous"
        ],
        correctAnswer: 1
    },
            {
                text: "Why do galaxy rotation curves remain flat at large radii?",
                options: [
                    "Gas pressure in extended disks contributes additional dynamical support that mimics the presence of extra unseen mass",
                    "Gravitational torques from interactions with nearby galaxies inject angular momentum into outer stellar populations",
                    "Non-luminous dark matter halo dominates the mass distribution at large radii",
                    "Strong stellar winds and radiation fields accelerate stars in the outskirts, sustaining orbital speeds against gravity"
                ],
                correctAnswer: 2
            },
               {
        text: "If the Universe had more dark matter than it does now, which outcome would most likely occur?",
        options: [
            "Galaxies would rotate more slowly",
            "The Universe would expand faster",
            "Large-scale structures would form earlier",
            "Stars would not form at all"
        ],
        correctAnswer: 2
    },
            {
                text: "Why do more massive stars live shorter lives?",
                options: [
                    "Their interiors remain cooler and less dense, which paradoxically causes them to process nuclear fuel inefficiently",
                    "Convective zones restrict mixing, leaving some hydrogen unburned and limiting the total available nuclear energy",
                    "Higher core temperatures cause vastly higher fusion rates that outpace the extra fuel",
                    "Strong stellar winds strip mass quickly, forcing them to exhaust their fuel supply regardless of the larger reservoir"
                ],
                correctAnswer: 2
            },
            {
    text: "Star A has an apparent magnitude of 1.5, while Star B has an apparent magnitude of 6.5. Which statement correctly describes their relative brightness as seen from Earth?",
    options: [
        "Star A appears brighter than Star B by exactly a factor of 10, since a 5-magnitude difference always corresponds to 10 times brightness.",
        "Star A appears brighter than Star B by about a factor of 100, since a difference of 5 magnitudes corresponds to a flux ratio of 100.",
        "Star A appears brighter than Star B by a factor of about 63, using the relation 2.512^(6.5 - 1.5) ≈ 100, which accounts for the logarithmic magnitude scale.",
        "Star A must be intrinsically more luminous than Star B by the same factor, since the apparent magnitude difference directly reflects luminosity regardless of distance."
    ],
    correctAnswer: 1
},
            {
        text: "If the Sun suddenly became a black hole of the same mass, what would happen to Earth’s orbit?",
        options: [
            "Earth would be pulled in and destroyed",
            "Earth would escape into interstellar space",
            "Earth would continue orbiting as before",
            "Earth would spiral slowly into the black hole"
        ],
        correctAnswer: 2
    },
            {
                text: "What does the Magorrian relation imply about galaxy–black hole co-evolution?",
                options: [
                    "Bulge growth proceeds independently and occurs after black hole accretion has essentially finished",
                    "Co-evolution: black-hole feedback and bulge assembly are linked through gas inflow/outflow regulation",
                    "Black-hole mass is determined solely by the angular momentum of the surrounding dark matter halo",
                    "The disk’s rotational dynamics directly fix the black-hole mass through long-term gravitational coupling"
                ],
                correctAnswer: 1
            },
            {
        text: "Why is the night sky dark (Olbers’ paradox)?",
        options: [
            "The Universe has a finite number of stars",
            "The Universe is infinite but stars are too far to see",
            "The Universe has a finite age, so light from all stars hasn’t reached us yet",
            "Interstellar dust absorbs most starlight"
        ],
        correctAnswer: 2
    },
            {
        text: "If the density of the Universe equals the critical density, what is the geometry of space?",
        options: [
            "Closed (spherical)",
            "Open (hyperbolic)",
            "Flat (Euclidean)",
            "Fractal-like"
        ],
        correctAnswer: 2
    },
            {
                text: "Why do AGN show broad emission lines?",
                options: [
                    "Gravitational redshift broadens lines in the narrow-line region far from the black hole",
                    "Dust scattering within the circumnuclear torus produces apparent spectral broadening across many lines",
                    "High-velocity gas near the black hole produces Doppler broadening; orientation and virial motions dominate",
                    "Absorption by stellar atmospheres artificially fills in narrow lines, making them appear broad in observations"
                ],
                correctAnswer: 2
            },
            {
                text: "How do Seyfert Type 1 and Type 2 galaxies differ spectroscopically?",
                options: [
                    "Type 1 spectra display only narrow emission lines, whereas Type 2 show exclusively broad emission lines",
                    "Type 1 shows broad + narrow emission lines; Type 2 shows only narrow lines due to orientation and obscuration",
                    "Type 1 is dominated by absorption features, while Type 2 galaxies contain emission-only line spectra",
                    "Both appear identical spectroscopically, and the classification is thought to be entirely historical in origin"
                ],
                correctAnswer: 1
            },
            {
        text: "Why does looking farther into space mean looking farther into the past?",
        options: [
            "The Universe bends time",
            "Light takes time to travel, so distant light shows earlier times",
            "Distant objects evolve faster",
            "Our telescopes distort the data"
        ],
        correctAnswer: 1
    },
            {
        text: "Why are tiny fluctuations in the cosmic microwave background important?",
        options: [
            "They show black holes existed early on",
            "They seeded the formation of galaxies and structure",
            "They are due to telescope errors",
            "They represent decaying stars in the early Universe"
        ],
        correctAnswer: 1
    },
            {
                text: "Why do pulsars spin down over time?",
                options: [
                    "Nuclear burning ceases in their cores, reducing angular momentum and slowing rotation",
                    "Magnetic dipole radiation and particle winds extract rotational energy and angular momentum",
                    "Accretion of matter onto the crust builds inertia that counteracts and slows the star’s spin",
                    "Gravitational tides from nearby objects exert drag that gradually decreases the pulsar’s spin rate"
                ],
                correctAnswer: 1
            },
            
            {
                text: "Why are RR Lyrae stars used as standard candles differently from Cepheids?",
                options: [
                    "RR Lyrae are universally younger stars than Cepheids, and their uniform age makes them useful for calibration",
                    "RR Lyrae have nearly constant luminosity; Cepheids use period–luminosity relation",
                    "Cepheids are restricted to globular clusters, whereas RR Lyrae occur across diverse galactic environments",
                    "RR Lyrae variability is stochastic in nature, limiting their use to simplified luminosity comparisons"
                ],
                correctAnswer: 1
            },{
    text: "Two stars, X and Y, are observed using precise astrometric measurements. Star X shows a parallax angle of 0.05 arcseconds, while Star Y shows a parallax angle of 0.10 arcseconds. Based on the definition of a parsec and the inverse relation between parallax and distance, which of the following statements is correct?",
    options: [
        "Star X is located at 20 parsecs and Star Y at 10 parsecs, meaning Star X is twice as far away as Star Y because distance is inversely proportional to the measured parallax angle.",
        "Star X must be at half the distance of Star Y, since a smaller parallax angle corresponds to a closer star, making Star X the nearer object.",
        "Both stars must be at nearly the same distance, because parallax measures only the apparent shift of position and cannot be directly converted into physical distances without knowing their intrinsic brightness.",
        "The star with the larger parallax angle, Star Y, must also be intrinsically fainter, since greater parallax always corresponds to lower stellar luminosity regardless of distance."
    ],
    correctAnswer: 0
},
            {
                text: "Why do synchrotron-emitting electrons in galaxies indicate past supernova activity?",
                options: [
                    "Dust scattering enhances ambient magnetic fields, boosting electron energy to relativistic levels",
                    "Electrons must be relativistically accelerated in shocks, most efficiently provided by supernova remnants",
                    "Stellar surfaces directly radiate synchrotron emission, and remnants only add to the observed flux",
                    "Large-scale cosmic expansion accelerates galactic electrons to high energies, producing the radiation"
                ],
                correctAnswer: 1
            },
            {
    text: "The observed correlation between supermassive black hole mass and the stellar velocity dispersion of a galaxy’s bulge (the M–σ relation) is often interpreted as evidence for co-evolution of galaxies and their central AGNs. Which explanation best captures the physical reasoning behind this correlation?",
    options: [
        "The black hole’s gravitational pull directly sets the orbital speeds of all stars in the bulge, so larger black holes automatically require faster stellar motions to remain bound",
        "During galaxy evolution, feedback from accreting black holes (jets, radiation, winds) injects energy into the surrounding gas, regulating star formation and dynamically coupling bulge growth with black hole growth",
        "Bulge stars continuously spiral inward through dynamical friction, feeding the black hole; thus, the stellar velocity dispersion and black hole mass increase in lockstep over cosmic time",
        "The correlation is an observational bias: only galaxies with massive black holes can be measured precisely, so the apparent M–σ relation does not reflect true co-evolution but rather selection effects in current samples"
    ],
    correctAnswer: 1
}

        ];

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                setupQuizStateListener();
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        // --- UI Navigation ---
        const views = ['role-selection-view', 'login-view', 'admin-view', 'participant-view'];
        function showView(viewId) {
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        window.showLogin = (role) => {
            currentRole = role;
            showView('login-view');
            document.getElementById('login-title').innerText = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
            document.getElementById('login-error').innerText = '';
            document.getElementById('password-input').value = '';
            const nameInput = document.getElementById('name-input');
            nameInput.classList.toggle('hidden', role !== 'participant');
            if (role === 'participant') nameInput.value = '';
        };

        window.showRoleSelection = () => {
            clearInterval(quizTimerInterval);
            clearInterval(adminTimerInterval);
            stopCornerCountdown();
            participantDocId = null;
            isSubmitted = false;
            showView('role-selection-view');
            document.getElementById('waiting-screen').style.display = 'block';
            document.getElementById('waiting-screen').innerHTML = `<h2 class="text-2xl font-bold mb-4">Welcome, <span id="participant-name" class="isro-orange font-orbitron"></span>!</h2><p class="text-gray-300 mb-6">The quiz will begin shortly. Please wait for the admin to start.</p><div class="loader mx-auto"></div>`;
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('ranking-screen').classList.add('hidden');
        };
        
        // --- Login Logic ---
        window.handleLogin = async () => {
            const password = document.getElementById('password-input').value;
            const name = document.getElementById('name-input').value;
            const errorEl = document.getElementById('login-error');

            if (!password || (currentRole === 'participant' && !name)) {
                errorEl.innerText = "All fields are required.";
                return;
            }

            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }

                const configDoc = await getDoc(doc(db, "quizConfig", "passwords"));
                if (!configDoc.exists()) {
                    await setDoc(doc(db, "quizConfig", "passwords"), { admin: "terabaap", participant: "nspd25" });
                    errorEl.innerText = "First-time setup complete. Default passwords have been set. Please try again.";
                    return;
                }
                
                const passwords = configDoc.data();
                if (currentRole === 'admin' && password === passwords.admin) {
                    showView('admin-view');
                } else if (currentRole === 'participant' && password === passwords.participant) {
                    isSubmitted = false;
                    const newDocRef = await addDoc(collection(db, "participants"), {
                        name: name, authUid: userId, answers: {}, score: 0, timeTaken: 0, submitted: false
                    });
                    participantDocId = newDocRef.id;
                    document.getElementById('participant-name').innerText = name;
                    showView('participant-view');
                } else {
                    errorEl.innerText = "Incorrect password.";
                }
            } catch (e) {
                console.error("Login error:", e);
                errorEl.innerText = "An error occurred.";
            }
        };

        // --- Real-Time Listener ---
        function setupQuizStateListener() {
            onSnapshot(doc(db, "quizState", "current"), (docSnap) => {
                const state = docSnap.exists() ? docSnap.data() : { status: 'waiting' };
                updateAdminStatus(`Status: ${state.status}`);
                document.getElementById('start-quiz-btn').disabled = state.status === "running";
                document.getElementById('show-results-btn').classList.toggle('hidden', state.status !== 'finished');
                
                if (currentRole === 'admin') {
                    if (state.status === 'running') {
                        startAdminTimer(state);
                    } else {
                        stopAdminTimer();
                    }
                }

                if (state.status !== 'finished') {
                    document.getElementById('admin-ranking-view').classList.add('hidden');
                }
                if (currentRole === 'participant') handleParticipantStateChange(state);
            });
        }

        async function handleParticipantStateChange(state) {
            const waitingScreen = document.getElementById('waiting-screen');
            const quizScreen = document.getElementById('quiz-screen');
            const rankingScreen = document.getElementById('ranking-screen');

            switch(state.status) {
                case 'waiting':
                    waitingScreen.style.display = 'block';
                    quizScreen.classList.add('hidden');
                    rankingScreen.classList.add('hidden');
                    stopCornerCountdown();
                    break;
                case 'running':
                    if (quizScreen.classList.contains('hidden') && !isSubmitted) {
                        waitingScreen.style.display = 'none';
                        quizScreen.classList.remove('hidden');
                        rankingScreen.classList.add('hidden');
                        startParticipantQuiz(state);
                    }
                    break;
                case 'finished':
                    if (!isSubmitted) {
                        await submitQuiz(true);
                    }
                    clearInterval(quizTimerInterval);
                    stopCornerCountdown();
                    quizScreen.classList.add('hidden');
                    rankingScreen.classList.add('hidden');
                    waitingScreen.style.display = 'block';
                    waitingScreen.innerHTML = `<h2 class="text-2xl font-bold mb-4 font-orbitron isro-orange">Quiz Over!</h2><p class="text-gray-300">Thank you for participating. The final results will be announced by the admin.</p>`;
                    break;
            }
        }
        
        function updateAdminStatus(message) {
            const statusEl = document.getElementById('admin-status');
            if (statusEl) statusEl.innerText = message;
        }

        // --- Admin Actions ---
        window.startQuiz = async () => {
            await setDoc(doc(db, "quizState", "current"), { status: "running", startTime: Date.now() });
            setTimeout(async () => {
                await setDoc(doc(db, "quizState", "current"), { status: "finished" }, { merge: true });
            }, quizDuration * 1000);
        };

        window.resetQuiz = async () => {
            const confirmation = await showCustomConfirm("Are you sure you want to reset the quiz? All participant data will be deleted.");
            if (!confirmation) {
                return;
            }
            await setDoc(doc(db, "quizState", "current"), { status: "waiting" });
            const participantsSnapshot = await getDocs(collection(db, "participants"));
            const batch = writeBatch(db);
            participantsSnapshot.forEach((doc) => batch.delete(doc.ref));
            await batch.commit();
            showCustomAlert("Quiz and all participant data have been reset.");
        };
        
        window.showAdminResults = () => {
            const rankingView = document.getElementById('admin-ranking-view');
            rankingView.classList.toggle('hidden');
            if (!rankingView.classList.contains('hidden')) displayAdminRankings();
        };
        
        // --- Custom Alert/Confirm Modals ---
        function showCustomAlert(message) {
            const alertModal = document.createElement('div');
            alertModal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            alertModal.innerHTML = `
                <div class="glass-card p-6 rounded-lg text-center max-w-sm w-full mx-4">
                    <p class="mb-4">${message}</p>
                    <button class="btn btn-primary">OK</button>
                </div>
            `;
            alertModal.querySelector('button').onclick = () => alertModal.remove();
            document.body.appendChild(alertModal);
        }

        function showCustomConfirm(message) {
            return new Promise(resolve => {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                confirmModal.innerHTML = `
                    <div class="glass-card p-6 rounded-lg text-center max-w-sm w-full mx-4">
                        <p class="mb-6">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                            <button id="confirm-ok" class="btn btn-primary bg-red-600 border-red-600 hover:text-red-600">Confirm</button>
                        </div>
                    </div>
                `;
                confirmModal.querySelector('#confirm-ok').onclick = () => {
                    confirmModal.remove();
                    resolve(true);
                };
                confirmModal.querySelector('#confirm-cancel').onclick = () => {
                    confirmModal.remove();
                    resolve(false);
                };
                document.body.appendChild(confirmModal);
            });
        }


        // --- Sound and Timer Functions ---
        function playBeep(duration = 0.1, freq = 880) {
            if (!audioCtx || audioCtx.state === 'suspended') return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration);
        }
        
        function createCountdown(element, state, playSound = false) {
            const globalStartTime = state.startTime;
            const update = () => {
                const elapsedSeconds = Math.floor((Date.now() - globalStartTime) / 1000);
                let timeLeft = quizDuration - elapsedSeconds;
                if (timeLeft >= 0) {
                    element.innerText = `${String(Math.floor(timeLeft/60)).padStart(2,'0')}:${String(timeLeft%60).padStart(2,'0')}`;
                    if (playSound) {
                        if (timeLeft === 10) playBeep(0.5);
                        else if (timeLeft < 10 && timeLeft > 0) playBeep();
                        else if (timeLeft === 0) playBeep(0.7, 523);
                    }
                } else {
                    element.innerText = "00:00";
                    return true;
                }
                return false;
            };
            return update;
        }

        function startAdminTimer(state) {
            const timerEl = document.getElementById('admin-timer');
            if (!timerEl) return;
            timerEl.classList.remove('hidden');
            if (adminTimerInterval) clearInterval(adminTimerInterval);
            const update = createCountdown(timerEl, state, true);
            update();
            adminTimerInterval = setInterval(() => {
                if (update()) clearInterval(adminTimerInterval);
            }, 1000);
        }

        function stopAdminTimer() {
            const timerEl = document.getElementById('admin-timer');
            if (timerEl) timerEl.classList.add('hidden');
            clearInterval(adminTimerInterval);
        }

        function startCornerCountdown(state) {
            const cornerTimerEl = document.getElementById('corner-countdown');
            if (!cornerTimerEl) return;
            cornerTimerEl.classList.remove('hidden');
            if (cornerTimerInterval) clearInterval(cornerTimerInterval);
            const update = createCountdown(cornerTimerEl, state);
            update();
            cornerTimerInterval = setInterval(() => {
                if (update()) clearInterval(cornerTimerInterval);
            }, 1000);
        }

        function stopCornerCountdown() {
            const cornerTimerEl = document.getElementById('corner-countdown');
            if (cornerTimerEl) cornerTimerEl.classList.add('hidden');
            clearInterval(cornerTimerInterval);
        }

        // --- Participant Quiz Logic ---
        function startParticipantQuiz(state) {
            currentQuestionIndex = 0;
            userAnswers = {};
            quizStartTime = Date.now();
            
            participantQuiz = questions.map(q => {
                const optionsToShuffle = q.options.map((optionText, index) => ({
                    text: optionText,
                    originalIndex: index
                }));
                shuffleArray(optionsToShuffle);
                return {
                    text: q.text,
                    shuffledOptions: optionsToShuffle,
                };
            });

            renderQuestion();
            startCornerCountdown(state);

            const timerEl = document.getElementById('timer');
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            const update = createCountdown(timerEl, state, true);
            update();
            quizTimerInterval = setInterval(() => {
                if (update()) {
                    clearInterval(quizTimerInterval);
                }
            }, 1000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderQuestion() {
            const question = participantQuiz[currentQuestionIndex];
            document.getElementById('question-text').innerText = `${currentQuestionIndex + 1}. ${question.text}`;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            question.shuffledOptions.forEach(shuffledOption => {
                const isSelected = userAnswers[currentQuestionIndex] === shuffledOption.originalIndex;
                const button = document.createElement('button');
                button.innerText = shuffledOption.text;
                button.className = `w-full text-left p-3 rounded-md transition-colors duration-200 ${isSelected ? 'bg-blue-600 text-white' : 'bg-gray-800 hover:bg-gray-700'}`;
                button.onclick = () => selectAnswer(shuffledOption.originalIndex);
                optionsContainer.appendChild(button);
            });

            document.getElementById('prev-btn').style.visibility = currentQuestionIndex === 0 ? 'hidden' : 'visible';
            document.getElementById('next-btn').classList.toggle('hidden', currentQuestionIndex === questions.length - 1);
            document.getElementById('submit-btn').classList.toggle('hidden', currentQuestionIndex !== questions.length - 1);
        }

        function selectAnswer(originalIndex) {
            userAnswers[currentQuestionIndex] = originalIndex;
            renderQuestion();
        }

        window.navigateQuestion = (direction) => {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < questions.length) {
                currentQuestionIndex = newIndex;
                renderQuestion();
            }
        };

        window.submitQuiz = async (isAutoSubmit = false) => {
            if (isSubmitted) return;
            isSubmitted = true;

            clearInterval(quizTimerInterval);
            stopCornerCountdown();
            if (!participantDocId) return console.error("Cannot submit: No participant document ID.");
            
            let score = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correctAnswer) score++;
            }
            try {
                await setDoc(doc(db, "participants", participantDocId), {
                    score: score, timeTaken: Math.round((Date.now() - quizStartTime) / 1000), submitted: true, answers: userAnswers
                }, { merge: true });
                if (!isAutoSubmit) {
                    document.getElementById('quiz-screen').classList.add('hidden');
                    const waitingScreen = document.getElementById('waiting-screen');
                    waitingScreen.style.display = 'block';
                    waitingScreen.innerHTML = `<h2 class="text-2xl font-bold mb-4">Thank You!</h2><p class="text-gray-300">Your submission has been received. Please wait for the quiz to end. The final results will be displayed by the admin.</p>`;
                }
            } catch (e) {
                console.error("Error submitting quiz:", e);
                const errorEl = document.getElementById('quiz-screen');
                errorEl.innerHTML = `<p class="text-red-400 text-center p-4">Could not submit your answers. Please check your connection.</p>`;
            }
        };

        // --- Ranking Logic ---
        async function displayAdminRankings() { await renderRankingList(document.getElementById('admin-ranking-list')); }

        async function renderRankingList(targetElement) {
            try {
                targetElement.innerHTML = '<div class="loader mx-auto"></div>';
                const participantsSnapshot = await getDocs(collection(db, "participants"));
                const rankings = [];
                participantsSnapshot.forEach(doc => rankings.push(doc.data()));
                rankings.sort((a, b) => b.score - a.score || a.timeTaken - b.timeTaken);
                targetElement.innerHTML = '';
                if (rankings.length === 0) {
                    targetElement.innerHTML = '<p class="text-center">No participants have joined yet.</p>';
                    return;
                }
                rankings.forEach((p, index) => {
                    const rankEl = document.createElement('div');
                    let rankClasses = 'flex justify-between items-center p-3 rounded-md border-l-4 ';
                    let resultHtml;
                    if (p.submitted) {
                        if (index === 0) rankClasses += 'bg-yellow-500/20 border-yellow-400';
                        else if (index === 1) rankClasses += 'bg-gray-500/20 border-gray-400';
                        else if (index === 2) rankClasses += 'bg-orange-500/20 border-orange-400';
                        else rankClasses += 'bg-gray-800/50 border-gray-700';
                        resultHtml = `<div class="text-right"><span class="font-bold text-lg text-isro-orange">${p.score}/${questions.length}</span><span class="text-sm text-gray-400 ml-2">(${p.timeTaken}s)</span></div>`;
                    } else {
                        rankClasses += 'bg-red-500/20 border-red-400 opacity-70';
                        resultHtml = `<div class="text-right"><span class="text-sm font-bold text-red-400">Did not finish</span></div>`;
                    }
                    rankEl.className = rankClasses;
                    rankEl.innerHTML = `<div class="flex items-center"><span class="font-bold text-xl w-8">${index + 1}.</span><span class="font-bold">${p.name}</span></div>${resultHtml}`;
                    targetElement.appendChild(rankEl);
                });
            } catch (e) {
                console.error("Error fetching rankings:", e);
                targetElement.innerHTML = '<p class="text-red-400 text-center">Could not load rankings.</p>';
            }
        }
        
        // Initial setup
        showView('role-selection-view');
        window.showRoleSelection = showRoleSelection;

    </script>
</body>
</html>
